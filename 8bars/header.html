<!--Shop Parameters-->
<script type="text/javascript">

    // set cmDiscount > 0 to apply discount
    let cmDiscount = 15;
    let cmCaseDiscount = 15;
    let accDiscount = 0;

    let bundleDiscountPer = 15;

    let freeDeliveryCost = 3000;
    let paidDeliveryCost = 300;

    const MAIN_PAGE = "/";
    let CM_INFO;
    let CM_CASE_INFO;
    let ACC_INFO;
    let PRODUCTS_INFO;

    // Shop parameters
    let infoMinipressoGr;
    let infoMinipressoNs;
    let infoNanopresso;
    let infoNanopressoNsAdapter;
    let infoNanopressoPatrol;
    let infoNanopressoTattoo;
    let infoNanopressoElements;
    let infoNanopressoJourney;
    let infoNanopressoElementsSale;
    let infoNsAdapter;
    let infoBaristaKit;
    let infoCase;
    let infoNanovessel;
    let infoPipamoka;

    let infoSet;
    let infoTest;

    function setProductsInfo() {
        infoMinipressoGr     = new ProductInfo(4790, 1, "/minipresso-gr");
        infoMinipressoNs     = new ProductInfo(4790, 2, "/minipresso-ns");

        infoNanopresso          = new ProductInfo(5990, 3, "/nanopresso");
        infoNanopressoPatrol    = new ProductInfo(5990, 4, "/nanopresso-patrol");

        infoNanopressoNsAdapter = new ProductInfo(7190, 21, "/nanopresso-and-ns-adapter");

        infoNanopressoTattoo = new ProductInfo(6990, 11, "/nanopresso-tattoo");
        infoNanopressoElements = new ProductInfo(6990, 13, "/nanopresso-elements");
        infoNanopressoJourney = new ProductInfo(6990, 17, "/nanopresso-journey");

        infoNsAdapter        = new ProductInfo(1890, 7, "/ns-adapter-nanopresso");
        infoBaristaKit       = new ProductInfo(2490, 8, "/barista-kit-nanopresso");

        infoCase             = new ProductInfo(1490, 9, "/nanopresso-minipresso-case");
        infoNanovessel       = new ProductInfo(1990, 12, "/nanovessel");

        infoPipamoka       = new ProductInfo(4790, 22, "/pipamoka");

        infoSet              = new ProductInfo(infoNanopresso.price, 100, "/");
        infoSet.discount = bundleDiscountPer;
        infoSet.discountType = "%";

        infoTest             = new ProductInfo(3000, 999, "/test-order");

        setLists();
        setDiscounts(CM_INFO, cmDiscount);
        setDiscounts(CM_CASE_INFO, cmCaseDiscount);
        setDiscounts(ACC_INFO, accDiscount);

        setDiscounts([infoMinipressoNs], 5);
        setDiscounts([infoNanopressoNsAdapter,], 10);
    }

    function setLists() {
        CM_INFO = [
            infoMinipressoGr, infoMinipressoNs,
            infoNanopresso, infoNanopressoPatrol,
            infoTest
        ];

        CM_CASE_INFO = [
            infoNanopressoTattoo,
            infoNanopressoElements,
            infoNanopressoElementsSale,
            infoNanopressoJourney
        ];

        ACC_INFO = [infoNsAdapter, infoBaristaKit, infoCase, infoNanovessel];

        PRODUCTS_INFO =
            CM_INFO
                .concat(CM_CASE_INFO)
                .concat(ACC_INFO)
                .concat([infoNanopressoNsAdapter, infoPipamoka]);
    }

    function setDiscounts(infos, discount) {
        if (discount > 0) {
            for (let idx in infos) {
                infos[idx].addDiscount(discount);
            }
        }
    }

    function ProductInfo(price, id, path) {
        this.price = price;
        this.oldPrice = undefined;
        this.discount = undefined;
        this.discountType = undefined;
        this.id = id;
        this.path = path;
        this.inStock = true;

        this.addDiscount = function (discount) {
            if (this.oldPrice === undefined) {
                this.oldPrice = this.price;
            }

            if (discount <= 100) {
                this.price = getDiscountPrice(this.oldPrice, discount);
                this.discount = discount;
                this.discountType = "%";
            } else {
                this.price -= discount;
                this.discount = discount;
                this.discountType = "rub";
            }
        };

        this.getPriceWithoutDiscount = function () {
            return this.oldPrice !== undefined ? this.oldPrice : this.price;
        };

        this.setInStock = function (inStock) {
            this.inStock = inStock;
        };

        this.isInStock = function () {
            return this.inStock;
        };

        this.getDiscount = function () {
            if (this.discount === undefined) {
                return 0;
            }

            return this.discount;
        };

        this.getDiscountStr = function () {
            if (this.discount === undefined) {
                return undefined;
            }

            if (this.discountType === "%") {
                return "-"+this.discount+"%";
            } else if (this.discountType === "rub") {
                return "-"+this.discount+" руб.";
            } else {
                return "";
            }
        }
    }

    function getDiscountPrice(oldPrice, discountPer) {
        let res = Math.floor(oldPrice * (1 - discountPer / 100));
        return res - (res % 10);
    }

    function DeliveryType(city, address, deliveryCompany, fullDeliveryCost) {
        this.city = city;
        this.address = address;
        this.deliveryCompany = deliveryCompany;
        this.fullDeliveryCost = fullDeliveryCost;
    }

    //fun func
    setProductsInfo();
</script>

<!--Init Parameters-->
<script type="text/javascript">
    let openTime;
    let page;
    let adminMode;

    let productInfo;
    let isProductPage;


    function init() {
        console.log("STATE: initSystem");

        openTime = new Date().getTime();
        page = document.location.pathname;
        adminMode = document.location.href.indexOf("admin") > -1;

        productInfo = getProductInfoByPagePath(page);
        isProductPage = productInfo !== undefined;

    }

    /**
     * @param {string} pagePath The string
     * @return {ProductInfo}
     */
    function getProductInfoByPagePath(pagePath) {
        if (pagePath === undefined || pagePath === "" || pagePath === MAIN_PAGE) {
            return undefined;
        }

        pagePath = pagePath.toLowerCase();

        // replace "/page/" -> "/page"
        if (pagePath.charAt(pagePath.length-1) === '/') {
            pagePath = pagePath.substr(0, pagePath.length-1);
        }

        for (let idx in PRODUCTS_INFO) {
            let productInfo = PRODUCTS_INFO[idx];

            if (productInfo.hasOwnProperty("path") && productInfo.path === pagePath) {
                return productInfo;
            }
        }

        console.log("productInfo not found by pagePath: " + pagePath);
        return undefined;
    }

    init();
</script>

<!--System Parameters-->
<script type="text/javascript">
    //JQuery objects
    let $cartForm;
    let $cartWindow;
    let $deliveryDescription;
    let $deliveryTypeRadios;
    let $deliveryClientCost;

    let $cartPhone;
    let $cartPhoneStr;

    let $deliveryAddressDiv;
    let $deliveryAddressInput;

    let $cityDiv;
    let $cityInput;

    let $deliveryIntervalDiv;
    let $deliveryIntervalInput;

    let $deliveryType;
    let $deliveryCompany;
    let $fullDeliveryCost;

    let $checkedDelivery;
    let $cdekDeliveryRadio;
    let $cdekDeliveryTimePost;
    let $cdekDeliveryTimePostValue;
    let $samovivozOrDeliveryCity;
    let $deliveryRussiaTab;

    let $buyOneClickBtn;
    let $buyOneClickFormBtn;

    $(document).ready(function(){
        console.log("STATE: readySystem");

        setGlobalJQ();

        readyAnalytics();
        readyFixPages();
        readyLogic();
    });

    function setGlobalJQ() {
        $cartForm = $('.t706 form');
        $cartWindow = $(".t706__cartwin");
        $deliveryDescription = $('.t-input-subtitle.t-descr');
        $deliveryTypeRadios = $("input:radio[name='DeliveryType']");
        $deliveryClientCost = $("input[name='DeliveryClientCost']");

        $cartPhone = $cartForm.find("input[name='Phone']");
        $cartPhoneStr = $cartForm.find("input[name='phoneStr']");

        $deliveryAddressInput = $('input:text[name=DeliveryAddress]');
        $deliveryAddressDiv = $deliveryAddressInput
            .parent()	// class="t-input-block"
            .parent();	// class="t-input-group t-input-group_in"

        $cityInput = $('input:text[name=city]');
        $cityDiv = $cityInput
            .parent()	// class="t-input-block"
            .parent();	// class="t-input-group t-input-group_in"

        $deliveryIntervalInput = $('input[name=deliveryInterval]');
        $deliveryIntervalDiv = $deliveryIntervalInput
            .parent()	// class="t-input-block"
            .parent();	// class="t-input-group t-input-group_in"

        $deliveryRussiaTab = $('#rec42659477').find('.t397__tab:last');

        $cdekDeliveryRadio = $deliveryTypeRadios.filter(function () {
            return isRussia($(this));
        });
        $cdekDeliveryTimePostValue = $('input[name="cdekDeliveryTimePostValue"]');

        $buyOneClickBtn = $("#rec139769290").find("a[href='#popup:buy-one-click']");
        $buyOneClickFormBtn = $("#rec139769178 button");
    }
</script>

<!--Analytics-->
<script type="text/javascript">

    // Wrapper for FB pixel
    let fbq2;

    function readyAnalytics() {
        console.log("STATE: readyAnalytics");

        fbq2 = fbq !== undefined ? fbq : undefinedFbq2Func;
        ym = ym !== undefined ? ym : undefinedYmFunc;

        if (isProductPage) {
            setFbTrackViewContent(productInfo.price, productInfo.id);
        }

        setMetrikaGoals();
        addGaToMetrika();
    }

    // Facebook
    {
        /**
         * @param {ProductInfo} productInfo
         */
        function setFbTrackAddToCart(productInfo) {
            fbq2('track', 'AddToCart', {
                value: productInfo.price,
                currency: 'RUB',
                content_ids: productInfo.id,
                content_type: 'product',
            });
        }

        function setFbTrackViewContent(value, content_ids) {
            fbq2('track', 'ViewContent', {
                value: value,
                currency: 'RUB',
                content_ids: content_ids,
                content_type: 'product',
            });
        }

        function setFbTracktInitiateCheckout(value) {
            fbq2('track', 'InitiateCheckout', {
                value: value,
                currency: 'RUB'
            });
        }

        function setFbTrackPurchase(value, content_ids, paymentId) {
            fbq2('track', 'Purchase', {
                value: value,
                currency: 'RUB',
                content_ids: content_ids,
                content_type: 'product',
                paymentId: paymentId
            });
        }

        function undefinedFbq2Func() {
            console.log("fbq2 is undefined, args: [" + arguments[0] + ", " + arguments[1] + "]");
        }
    }

    // Yandex Metrika
    {
        function addGaToMetrika() {
            function getCookie(name) {
                var matches = document.cookie.match(new RegExp(
                    "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
                ));
                return matches ? decodeURIComponent(matches[1]) : undefined;
            }

            let google_client_id = getCookie('_ga') ? getCookie('_ga').slice(6) : '';

            ym(ymCounterNum, 'params', {_ga: google_client_id});
        }

        function setMetrikaGoals() {
            $("[href='#order']").click(function () {
                reachMetrikaGoal("AddToCart");
            });

            $('.t706__carticon').click(function () {
                reachMetrikaGoal("OpenCartPopUp");
            });

            //Stats for CDEK widget
            $deliveryRussiaTab.click(function () {
                reachMetrikaGoalViaParams("OpenDeliveryRussiaTab");
            });

            $cdekDeliveryRadio.click(function () {
                reachMetrikaGoalViaParams("OpenDeliveryRussiaRadioInCart");
            });

            $buyOneClickBtn.click(function () {
                reachMetrikaGoal("ClickBuyOneClickBtn");
            });
        }

        function reachMetrikaGoal(goalName) {
            console.log("send " + goalName + " to yaMetrika");
            ym(ymCounterNum, 'reachGoal', goalName);
        }

        function getTimeSinceOpenInMins() {
            let timeSinceReadyInSecs = Math.floor((new Date().getTime() - openTime) / 1000);
            let timeSinceReadyInMins = Math.floor(timeSinceReadyInSecs / 60);
            timeSinceReadyInSecs = timeSinceReadyInSecs % 60;

            let res = "";
            if (timeSinceReadyInMins !== 0) {
                res += timeSinceReadyInMins + "m";
            }

            return res += timeSinceReadyInSecs + "s";
        }

        function undefinedYmFunc() {
            console.log("ym is undefined, args: [" + arguments[0] + ", " + arguments[1] + "]");
        }
    }

</script>

<!--Fix pages-->
<script type="text/javascript"
>
    let $h1;
    let h1Text;
    let $mainProductRec = $();
    let $allJsProducts;
    let $productsPageSmallDesc;
    let $setSmallDesc;

    function readyFixPages() {
        console.log("STATE: readyFixPages");

        $h1 = $('h1');
        h1Text = $h1.text();
        $allJsProducts = $('div.js-product');

        initHtmlElements();
        fixProductCarts();

        if (isProductPage) {
            $mainProductRec = $h1.parents('.t-rec');

            addMicrodata();
            setAltForAllProductPics();
            setLastBreadCrumbName();
            setPointNavigationProductName();
            moveBuyOneClickButtonToProductCart();
        }
    }

    // Fix products pages functions
    {

        function initHtmlElements() {
            $productsPageSmallDesc = $(
                '<div class="t744__title_small t-descr t-descr_xxs" field="title3" style="font-size: 16px;">' +
                '    <span stockType="in" style="font-size: 20px;font-weight: normal;color: green;">В наличии</span>' +
                '    <span stockType="out" style="font-size: 20px;font-weight: lighter;color: red; display: none;">Нет в наличии</span>' +
                '    <br>' +
                '    <a href="#popup:lower-price">Нашли дешевле? Снизим цену!</a>' +
                '    <br>' +
                '</div>');

            $setSmallDesc = $(
                '<div class="t744__title_small t-descr t-descr_xxs" field="title3" style="font-size: 16px;">' +
                'Комплект на все случаи жизни' +
                '</div>');
        }

        function fixProductCarts() {

            $allJsProducts.each(function (idx) {
                let prod = $(this);

                let productName = prod.find(".js-product-name").text();
                let isSet = productName.toLowerCase().indexOf("set") !== -1;

                let currentPriceValueDiv = prod.find('.js-product-price');
                let buyButton = prod.find("[href='#order']");

                let oldPriceDiv = prod.find("div[class*='price_old']");
                let oldPriceValueDiv = oldPriceDiv.find("div[class*='price-value']");

                let productImg = prod.find("div[class*='imgwrapper']");

                let isSingleProductCard = prod.hasClass("js-product-single") || prod.hasClass("t778__product-full");
                let isLineProduct = prod.hasClass("t778__col");

                let productInfo = getProductInfoByProductName(productName);

                if (productInfo === undefined) {
                    console.error("Couldn't find info for: " + productName);
                    return;
                }

                if (isSingleProductCard) {
                    let $productSku = prod.find(".js-product-sku");
                    $productSku = prod.find('.js-product-sku');
                    $productSku.hide();

                    if (isSet) {
                        let clone = $setSmallDesc.clone();
                        $productSku.after(clone);
                    } else {
                        let clone = $productsPageSmallDesc.clone();
                        $productSku.after(clone);

                        if (!productInfo.isInStock()) {
                            prod.find("span[stockType='in']").hide();
                            prod.find("span[stockType='out']").show();

                            buyButton.find('.js-store-prod-buy-btn-txt').text("Предзаказ");
                        }
                    }
                }

                if (!productInfo.isInStock()) {
                    if (isLineProduct) {
                        let lineDescr = prod.find('.t778__descr');
                        lineDescr.empty();

                        let clone = $productsPageSmallDesc.find("span[stockType='out']").clone();
                        clone.show();
                        lineDescr.append(clone);

                        buyButton.find('td').text("Предзаказ");
                    }

                }

                if (productInfo.getDiscount() !== 0) {
                    let $markOnLineCards = $('<div class="t778__markwrapper"><div class="t778__mark"></div></div>');

                    $markOnLineCards.children('.t778__mark').text(productInfo.getDiscountStr());
                    productImg.append($markOnLineCards);
                }

                if (isSet) {
                    buyButton.click(function () {
                        setFbTrackAddToCart(infoSet);
                    });
                } else {
                    setPrices(productInfo, productName, currentPriceValueDiv, oldPriceDiv, oldPriceValueDiv);

                    buyButton.click(function () {
                        setFbTrackAddToCart(productInfo);
                    });
                }

                console.log(productName + " fixed");
            });

        }

        /**
         * @param {ProductInfo} productInfo
         */
        function setPrices(productInfo, productName, currentPriceValueDiv, oldPriceDiv, oldPriceValueDiv) {
            currentPriceValueDiv.text(productInfo.price);

            if (productInfo.oldPrice === undefined) {
                oldPriceDiv.hide();
            } else {
                oldPriceDiv.show();
                oldPriceValueDiv.text(productInfo.oldPrice);
            }

            console.log(productName +": cur=" + currentPriceValueDiv.text() + ", old=" + oldPriceValueDiv.text());
        }

        function addMicrodata(){
            let productMD = $mainProductRec.find(".js-product-single");

            productMD
                .attr("itemscope", "")
                .attr("itemtype", "http://schema.org/Product");

            let imageLink = productMD.find('div[bgimgfield="gi_img__0"]').eq(0).attr("data-img-zoom-url");
            if (imageLink !== undefined) {
                productMD.find(".t-slds")
                    .attr("itemprop", "image")
                    .attr("content", imageLink);
            }

            productMD.find("h1").attr("itemprop", "name");
            productMD.find(".t744__descr").attr("itemprop", "description");

            productMD.find(".t744__title_small")
                .attr("itemprop", "brand")
                .attr("content", "Wacaco");

            let offerMD = productMD.find(".t744__price-wrapper");
            offerMD
                .attr("itemprop", "offers")
                .attr("itemScope", "")
                .attr("itemType", "http://schema.org/Offer");

            offerMD.append("<meta itemProp=\"availability\" content=\"http://schema.org/InStock\">");

            let $jsProductPrice = offerMD.find(".js-product-price");
            $jsProductPrice
                .attr("itemprop", "price")
                .attr("content", $jsProductPrice.text());

            offerMD.find(".t744__price-currency")
                .attr("itemprop", "priceCurrency")
                .attr("content", "RUB");

            console.log("Microdata were added.")
        }

        function setAltForAllProductPics() {
            $('.js-product-img').each(function () {
                $(this).attr('alt', h1Text);
            });
        }

        function setLastBreadCrumbName() {
            $('.t758__link-item_active').text(h1Text);
        }

        function setPointNavigationProductName() {
            $('a[href="#product"] > .t607__tooltip').text(h1Text)
        }

        function moveBuyOneClickButtonToProductCart() {
            let $addToCartBtn = $mainProductRec.find("div.t744__btn-wrapper a[href='#order']");

            $addToCartBtn.after($buyOneClickBtn);
            $buyOneClickBtn.show();
            $buyOneClickBtn.css("margin-left", "20px");
        }

        /**
         * @param {string} productName The string
         * @return {ProductInfo}
         */
        function getProductInfoByProductName(productName) {
            if (productName === undefined) {
                return undefined;
            }

            productName = productName.toLowerCase();

            if (productName.indexOf("tattoo") > -1)     return infoNanopressoTattoo;
            if (productName.indexOf("elements") > -1) return infoNanopressoElements;
            if (productName.indexOf("journey") > -1)     return infoNanopressoJourney;

            if (productName.indexOf("nanopresso+ns-адаптер") > -1)     return infoNanopressoNsAdapter;

            if (productName.indexOf("ns-адаптер") > -1) return infoNsAdapter;
            if (productName.indexOf("barista") > -1)    return infoBaristaKit;
            if (productName.indexOf("чехол") > -1)      return infoCase;
            if (productName.indexOf("nanovessel") > -1) return infoNanovessel;
            if (productName.indexOf("pipamoka") > -1) return infoPipamoka;

            if (productName.indexOf("minipresso") > -1) {
                if (productName.indexOf("ns") > -1) {
                    return infoMinipressoNs;
                } else {
                    return infoMinipressoGr;
                }
            }

            if (productName.indexOf("patrol") > -1)     return infoNanopressoPatrol;
            if (productName.indexOf("set") > -1)        return infoSet;
            if (productName.indexOf("nanopresso") > -1) return infoNanopresso;

            if (productName.indexOf("тест") > -1)       return infoTest;

            console.log("productInfo not found by productName");
            return undefined;
        }
    }

</script>

<!--Logic-->
<script type="text/javascript">

    // Configuration
    const fixDeliveryPriceCheckInterval = 500;
    const changeDuration = 400;

    //Cdek
    let cdekDeliveryWidget;
    let cdekPvzInfoWidget;

    let currentDelivery;
    let selfTakeDelivery = new DeliveryType("Москва", "Самовывоз", "Самовывоз", "0");
    let mskDelivery = new DeliveryType("Москва", "", "Ontime", "_???");
    let cdekDelivery = new DeliveryType("", "", "Ontime-CDEK", "_???");

    function readyLogic() {
        console.log("STATE: readyLogic");

        setAdminElements();

        fixCartWindowFields();

        addChangingSkuWhenChangedVariant();
        setJivoChatOpenByClickInContacts();
        initInitiateCheckoutFunction();
        initMyAfterSendedFunction();

        if (isProductPage) {
            addChangingProductPicWhenChange1Variant();
        }

        // waitVar(function(){return window.tcart_initted;}, fixDeliveryPriceFunc);
    }

     $( window ).load(function() {
         initCdekDeliveryWidget('order');
         $deliveryRussiaTab.click(function () {
             initCdekDeliveryWidget('info');
         });
     });

    function setAdminElements() {
        let $sendSmsGroup = $cartForm.find(".t-input-group").has("input[name='SendSmsAboutOrder']");
        let $infoThemeGroup = $cartForm.find(".t-input-group").has("input[name='infoTheme']");
        $infoThemeGroup.find("input[name='infoTheme']").val(" ");

        if (adminMode) {
            $sendSmsGroup.show();
            $infoThemeGroup.show();
        } else {
            $sendSmsGroup.hide();
            $infoThemeGroup.hide();
        }

    }

    // Events function
    {

        function addChangingSkuWhenChangedVariant() {
            //$allJsProducts = $('div.js-product');
            $allJsProducts.each(function (idx) {
                let prod = $(this);
                let productName = prod.find(".js-product-name").text();

                let $productSku = prod.find(".js-product-sku");
                let genericSku = $productSku.text().trim();
                $productSku.attr('generic-sku', genericSku);

                // need identify sku by options
                if (genericSku.includes("_X")) {
                    let productFirstOption = prod.find('div.js-product-option').eq(0);

                    if (productFirstOption.get(0) !== undefined) {
                        let optionName = simplifyJsNameLower(productFirstOption.find('.js-product-option-name').text());
                        let variants = productFirstOption.find('select.js-product-option-variants');

                        variants.change(function () {
                            let selectedValue = $(this).val();
                            let keySku = genericSku + ":" + optionName + ":" + simplifyJsNameLower(selectedValue);

                            let realSku = mapOfSku[keySku];

                            if (realSku !== undefined) {
                                $productSku.text(realSku);
                                console.log(productName + ": sku=" + realSku + " by " + keySku);
                            } else {
                                console.error(productName + ": keySku=" + keySku + " not found realSku");
                            }
                        });

                        variants.trigger('change');
                    }
                }
            });
        }


        function setJivoChatOpenByClickInContacts() {
            $('a[href="#jivosite_open"]').click(function(){jivo_api.open();});
        }

        function initInitiateCheckoutFunction() {
            let $nameInput = $cartForm.find("input[name='Name']");

            $nameInput.one("keyup", function () {
                setFbTracktInitiateCheckout(tcart.prodamount);
                reachMetrikaGoal("InitiateCheckout");
            });

            $cartPhone.change(getFields);
            $cartForm.find("input[name='Email']").change(getFields);
            function getFields() {
                let name = $(this).attr('name');
                let val = $(this).val();

                reachMetrikaGoalViaParams({name: name, val: val}, true);
            }
        }

        function initMyAfterSendedFunction() {
            window.myAfterSendedFunction = function ($form) {
                let content_idsArr = [];
                for (let idx in tcart.products) {
                    let productName = tcart.products[idx].name;
                    let productInfo = getProductInfoByProductName(productName);

                    if (productInfo === undefined) {
                        console.warn("Couldn't find info for: " + productName);
                    } else {
                        content_idsArr.push(productInfo.id);
                    }
                }

                let paymentId = getPaymentId(tildaForm.orderIdForStat);

                setFbTrackPurchase(tcart.prodamount, content_idsArr, paymentId);
                reachMetrikaGoal("Purchase");

                /**
                 * @param {string} orderIdForStat
                 * e.g. "T201907-1837361908"
                 */
                function getPaymentId(orderIdForStat) {
                    if (orderIdForStat === undefined || orderIdForStat === "") {
                        return "";
                    }

                    let start = orderIdForStat.indexOf("-") + 1;
                    let end = orderIdForStat.length - 1;

                    return orderIdForStat.substr(start, end);
                }
            };

            $cartForm.each(function () {
                $(this).data('formsended-callback', 'window.myAfterSendedFunction');
            });
        }

        function addChangingProductPicWhenChange1Variant() {
            let productFirstVariant = $mainProductRec.find('select.js-product-option-variants').eq(0);

            if (productFirstVariant.get(0) !== undefined) {
                //select right pic when change variant
                productFirstVariant.change(function (event, param) {
                    let num = $(this).prop("selectedIndex") + 1;

                    $mainProductRec.find('.t-slds__bgimg-contain').removeClass("js-product-img");
                    $mainProductRec.find(".t-slds__item[data-slide-index='" + num + "']").find('.t-slds__bgimg-contain').addClass("js-product-img")

                    if (param !== "skip-bullet-click") {
                        $mainProductRec.find(".t-slds__bullet[data-slide-bullet-for='" + num + "']").click();
                    }
                });

                let theFirstBullet = $mainProductRec.find('.t-slds__bullet').eq(0).get(0);
                new MutationObserver(function (mutationsList) {
                    let activeBullet = $mainProductRec.find('.t-slds__bullet.t-slds__bullet_active');
                    changeVarintByBullet(activeBullet);
                }).observe(theFirstBullet, {attributes: true, attributeOldValue:true, attributeFilter: ["class"]});

                console.log("Add listeners pictures <--> variants");
            }

            function changeVarintByBullet(activeBullet){
                let idx = activeBullet.attr("data-slide-bullet-for")-1;

                if (idx !== productFirstVariant.prop("selectedIndex")) {
                    let optionName = productFirstVariant.find("option").eq(idx).val();
                    if (optionName !== undefined) {
                        productFirstVariant.val(optionName).trigger('change', "skip-bullet-click");
                    }
                }
            }
        }
    }

    // Delivery functions
    {
        function fixDeliveryInCart() {
            $cdekDeliveryRadio.parent().append("<span id=\"cdekDeliveryTimePost\"></span>");
            $cdekDeliveryTimePost = $cdekDeliveryRadio.parent().find('#cdekDeliveryTimePost');
            $samovivozOrDeliveryCity = $cartForm.find('input[name="samovivozOrDeliveryCity"]');

            $deliveryType = $cartForm.find('input[name="DeliveryType"]');
            $deliveryCompany = $cartForm.find('input[name="DeliveryCompany"]');
            $fullDeliveryCost = $cartForm.find('input[name="fullDeliveryCost"]');
            $deliveryType.each(function () {
                let val = $(this).val().replace(/=.*/,"");
                let simplified = simplifyJsName(val);
                $(this).val(simplified);
            });

            //default Moscow delivery
            $checkedDelivery = $deliveryTypeRadios.filter(function () {
                return isMoscow($(this));
            });
            $checkedDelivery.prop("checked", true);
            setDefaultMoscow();

            //event listener
            $deliveryTypeRadios.change(function () {
                $checkedDelivery = $deliveryTypeRadios.filter(":checked");

                if (isSamovivoz($checkedDelivery)) {
                    setDefaultSamovivoz();

                } else if (isMoscow($checkedDelivery)) {
                    setDefaultMoscow();

                } else if (isRussia($checkedDelivery)) {
                    setDefaultRussia();
                }
            });
        }

        function setDefaultSamovivoz() {
            $cityDiv.hide(changeDuration);
            $deliveryAddressDiv.hide(changeDuration);
            $deliveryIntervalDiv.hide(changeDuration);
            $cdekDeliveryTimePost.hide(changeDuration);

            setDelivery(selfTakeDelivery);
        }

        function setDefaultMoscow() {
            $cityDiv.hide(changeDuration);
            $deliveryAddressDiv.show(changeDuration);
            $deliveryIntervalDiv.show(changeDuration);
            $cdekDeliveryTimePost.hide(changeDuration);

            setDelivery(mskDelivery);
        }

        function setDefaultRussia() {
            $cityDiv.show(changeDuration);
            $deliveryAddressDiv.show(changeDuration);
            $deliveryIntervalDiv.hide(changeDuration);
            $cdekDeliveryTimePost.show(changeDuration);

            cdekDeliveryWidget.open();
        }

        function setDelivery(checkedDelivery) {
            if (currentDelivery !== undefined) {
                currentDelivery.city = $cityInput.val();
                currentDelivery.address = $deliveryAddressInput.val();
            }

            currentDelivery = checkedDelivery;

            $cityInput.val(currentDelivery.city);
            $deliveryAddressInput.val(currentDelivery.address);
            $deliveryCompany.val(currentDelivery.deliveryCompany);
            $fullDeliveryCost.val(currentDelivery.fullDeliveryCost);

            if (currentDelivery === selfTakeDelivery) {
                $samovivozOrDeliveryCity.val(selfTakeDelivery.address);
            } else {
                $samovivozOrDeliveryCity.val(currentDelivery.city);
            }

            console.log("Delivery: " + $cityInput.val() + ", " + $deliveryAddressInput.val());
        }

        function initCdekDeliveryWidget(type) {
            let apikey = 'aa735970-60bf-4090-b32d-083b360acd6f';

            if (type === 'info') {
                cdekPvzInfoWidget = new ISDEKWidjet({
                    hidedress: true,
                    choose: false,
                    link: 'cdek-pvz-info-widjet',
                    defaultCity: 'Москва',
                    cityFrom: 'Москва',
                    path: cdekPvzWidgetScriptsPath,
                    goods: [ // установим данные о товарах из корзины
                        { length : 10, width : 10, height : 10, weight : 0.5 }
                    ],
                    apikey: apikey,
                    onReady : onReady,
                    onCalculate : onCalculate,
                    onChoose : onChoose,
                    onChooseProfile : onChoose
                });
            } else { //type === 'order'
                cdekDeliveryWidget = new ISDEKWidjet({
                    popup: true,
                    hidedress: true,
                    defaultCity: 'Москва',
                    cityFrom: 'Москва',
                    path: cdekPvzWidgetScriptsPath,
                    goods: [ // установим данные о товарах из корзины
                        {length: 10, width: 10, height: 10, weight: 0.5}
                    ],
                    apikey: apikey,
                    onReady: onReady,
                    onCalculate: onCalculate,
                    onChoose: onChoose,
                    onChooseProfile: onChoose
                });
            }

            function onReady() {
            }

            function onCalculate(info) {
            }

            function onChoose(info) {
                // setDelivery(cdekDelivery);

                if (info.term === undefined) {
                    $cdekDeliveryTimePost.text("");
                    $cdekDeliveryTimePostValue.val("???");

                } else if (info.term === info.termOriginal){
                    $cdekDeliveryTimePost.text(" (срок ~" + info.term + ")");
                    $cdekDeliveryTimePostValue.val(info.term);

                } else {
                    $cdekDeliveryTimePost.text(" (" + info.term + ")");
                    $cdekDeliveryTimePostValue.val("Original: " + info.termOriginal + " дн., shown: " + info.term);
                }

                cdekDelivery.city = info.cityName;
                // $cityInput.val(info.cityName);

                if (info.PVZ !== undefined) {
                    // $deliveryAddressInput.val("ПВЗ: " + info.PVZ.Address);
                    cdekDelivery.address = "ПВЗ: " + info.PVZ.Address;
                } else {
                    cdekDelivery.address = "";
                    // if ($deliveryAddressInput.val().indexOf("ПВЗ:") === 0) {
                    //     $deliveryAddressInput.val("");
                    // }
                }

                setDelivery(cdekDelivery);
            }
        }


        function isSamovivoz(checkedDelivery) {
            return checkedDelivery !== undefined && checkedDelivery.val().toLowerCase().indexOf("самовывоз") > -1;
        }

        function isMoscow(checkedDelivery) {
            return checkedDelivery !== undefined && checkedDelivery.val().toLowerCase().indexOf("курьер") > -1;
        }

        function isRussia(checkedDelivery) {
            return checkedDelivery !== undefined && checkedDelivery.val().toLowerCase().indexOf("росси") > -1;
        }
    }

    // Fix cart functions
    {
        function fixCartWindowFields() {
            fixDeliveryInCart();
            fixPromoCodeInCart();

            $cartPhone.change(changeCartPhoneStr);
        }

        function fixPromoCodeInCart() {
            let $promoGroup = $cartForm.find(".t-input-group_pc");

            let $hasPromoCbGroup = $cartForm.find(".t-input-group_cb").has("input[name='hasPromo']");

            if (cmDiscount === 0) {
                $hasPromoCbGroup.one('change', function () {
                    $hasPromoCbGroup.hide(changeDuration);
                    $promoGroup.show(changeDuration);
                });
            } else {
                $hasPromoCbGroup.hide();
            }
        }

        function fixDeliveryPriceFunc() {
            setInterval(function () {
                if (isCartWinShowed()) {
                    let prodamount = window.tcart.prodamount;
                    let amount = window.tcart.amount;

                    if (prodamount !== undefined && amount !== undefined) {
                        let shouldPaid = !isSamovivoz($checkedDelivery) && prodamount < freeDeliveryCost && amount === prodamount;
                        let shouldFree = (isSamovivoz($checkedDelivery) || prodamount >= freeDeliveryCost) && amount !== prodamount;

                        if (shouldPaid || shouldFree) {

                            if (shouldPaid) {
                                $checkedDelivery.attr("data-delivery-price", paidDeliveryCost);
                            }

                            if (shouldFree) {
                                $checkedDelivery.attr("data-delivery-price", 0);
                            }

                            window.tcart.delivery = {};
                            window.tcart.delivery.name = $checkedDelivery.val();
                            window.tcart.delivery.price = $checkedDelivery.attr("data-delivery-price");

                            tcart__updateTotalProductsinCartObj(),
                                tcart__reDrawTotal();
                        }

                        if ($checkedDelivery.attr("data-delivery-price") === "") {
                            $deliveryClientCost.val(0);
                        } else {
                            $deliveryClientCost.val($checkedDelivery.attr("data-delivery-price"));
                        }
                    }
                }
            }, fixDeliveryPriceCheckInterval);

            function isCartWinShowed() {
                if ($cartWindow === undefined) {
                    $cartWindow = $(".t706__cartwin");
                }

                return $cartWindow.hasClass("t706__cartwin_showed")
            }
        }

        function changeCartPhoneStr() {
            let phone = $cartPhone.val();
            let phoneStr = phone.replace(/\+8/,"\+7").replace(/[\+ \(\)-]/g,"");

            $cartPhoneStr.val(phoneStr);
        }
    }

    // Utils functions
    {
        function jivo_onLoadCallback() {
            if (window.jivo_config !== undefined)  {
                window.jivo_config.logs = undefined;
            }
        }

        function jivo_onClose() {
            reachMetrikaGoalViaParams("CloseJivoWidget");
        }

        function jivo_onOpen() {
            reachMetrikaGoalViaParams("OpenJivoWidget");
        }

        function simplifyJsName(name) {
            return extTrim(name
                .replace(/\(.*\)/g, "")
            );
        }

        function simplifyJsNameLower(name) {
            return extTrim(name
                .replace(/\(.*\)/g, "")
                .toLowerCase()
            );
        }

        function extTrim(str) {
            return str.replace(/\s{2,}/g," ").trim();
        }

        function waitVar(variable, callback) {
            let maxCount = 10;
            let interval = setInterval(function () {
                try {
                    if (maxCount < 0 || (variable() !== undefined && interval !== undefined) ) {
                        clearInterval(interval);
                        callback();
                    }
                } catch (e) {
                    //ignore
                };
                maxCount--;
            }, 1000);
        }
    }



</script>