<script type="text/javascript">

    // Shop parameters
    let priceMinipresso;
    let priceNanopresso;
    let priceNanopressoTattoo;
    let priceNsAdapter;
    let priceBaristaKit;
    let priceCase;
    let priceNanovessel;
    function setPricesVariables() {
        priceMinipresso = getPriceWithDiscount(4790);
        priceNanopresso = getPriceWithDiscount(5990);
        priceNanopressoTattoo = getPriceWithDiscount(6500);

        priceNsAdapter = new Price(1890);
        priceBaristaKit = new Price(2490);
        priceCase = new Price(1490);
        priceNanovessel = new Price(1990);
    }

    let productDiscount = 1000;
    let bundleDiscountPer = 10;

    let freeDeliveryCost = 3000;
    let paidDeliveryCost = 300;

    // Defaults
    const MAIN_PAGE = "/";
    const PRODUCTS_PAGES = [
        "/minipresso-gr",
        "/minipresso-ns",
        "/nanopresso",
        "/nanopresso-patrol",
        "/ns-adapter-nanopresso",
        "/barista-kit-nanopresso",
        "/nanopresso-minipresso-case",
        "/nanopresso-tattoo",
        "/nanovessel"
    ];

    let page = MAIN_PAGE;
    let isProductPage = false;
    let adminMode = false;

    // Configuration
    const fixDeliveryPriceCheckInterval = 500;
    const changeDuration = 400;

    // HTML elements
    //let yaCounter44688592;

    let deliveryAddressDiv;
    let deliveryAddressInput;

    let cityDiv;
    let cityInput;

    let deliveryIntervalDiv;
    let deliveryIntervalInput;

    let h1Text;

    //JQuery objects
    let $cartWindow;
    let $deliveryDescription;
    let $deliveryTypeRadios;
    let $deliveryClientCost;

    let $checkedDelivery;

    $(document).ready(function(){
        setGlobalVariables();
        setPricesVariables();

        setAdminElements();

        setMetrikaGoals();
        setCartWindowFields();

        setPrices();

        if (isProductPage) {
            setLastBreadCrumbName();
            setPointNavigationProductName();
        }

        waitVar(function(){return window.tcart_initted;}, fixDeliveryPriceFunc);
    });

    function setGlobalVariables() {
        let location = document.location;
        if (location !== undefined) {
            page = location.pathname;
            isProductPage = PRODUCTS_PAGES.indexOf(page.toLowerCase()) !== -1;
        }

        if (page.indexOf("admin") > -1) {
            adminMode = true;
        }

        $cartWindow = $(".t706__cartwin");
        $deliveryDescription = $('.t-input-subtitle.t-descr');
        $deliveryTypeRadios = $("input:radio[name='deliveryType']");
        $deliveryClientCost = $("input[name='deliveryClientCost']");

        deliveryAddressInput = $('input:text[name=deliveryAddress]');
        deliveryAddressDiv = deliveryAddressInput
            .parent()	// class="t-input-block"
            .parent();	// class="t-input-group t-input-group_in"

        cityInput = $('input:text[name=city]');
        cityDiv = cityInput
            .parent()	// class="t-input-block"
            .parent();	// class="t-input-group t-input-group_in"

        deliveryIntervalInput = $('input[name=deliveryInterval]');
        deliveryIntervalDiv = deliveryIntervalInput
            .parent()	// class="t-input-block"
            .parent();	// class="t-input-group t-input-group_in"

        h1Text = $('h1').text();
    }

    function setAdminElements() {
        let sendSmsCheckbox = $('input:checkbox[name=SendSmsAboutOrder]');
        let sendSmsDiv = sendSmsCheckbox
            .parent()	// class="t-checkbox__control t-text t-text_xs"
            .parent()	// class="t-input-block"
            .parent();	// class="t-input-group t-input-group_cb"

        if (adminMode) {
            sendSmsDiv.show();
        } else {
            sendSmsDiv.hide();
        }

    }

    function setMetrikaGoals() {
        $("[href='#order']").click(function() {
            console.log('Goal: OpenCartPopUp by #order');

            console.log("send to yaCounter44688592");
            if (yaCounter44688592 !== undefined) {
                yaCounter44688592.reachGoal('OpenCartPopUp');
            } else {
                console.log("yaCounter44688592 is undefined")
            }

            console.log("send to fbq AddToCart");
            fbq('track', 'AddToCart');
        });

        $('.t706__carticon').click(function(){
            console.log('Goal: OpenCartPopUp by .t706__carticon');

            console.log("send to yaCounter44688592");
            if (yaCounter44688592 !== undefined) {
                yaCounter44688592.reachGoal('OpenCartPopUp');
            } else {
                console.log("yaCounter44688592 is undefined")
            }

            console.log("send to fbq InitiateCheckout");
            fbq('track', 'InitiateCheckout');
        });
    }

    function setCartWindowFields() {
        $checkedDelivery = $deliveryTypeRadios.filter(function () {return isMoscow($(this));});
        $checkedDelivery.prop("checked", true);
        setDefaultMoscow();

        $deliveryTypeRadios.change(function(){
            $checkedDelivery = $deliveryTypeRadios.filter(":checked");

            if (isSamovivoz($checkedDelivery)) {
                setDefaultSamovivoz();

            } else if (isMoscow($checkedDelivery)) {
                setDefaultMoscow();

            } else if (isRussia($checkedDelivery)) {
                setDefaultRussia();
            }
        });

        function setDefaultSamovivoz() {
            cityDiv
                .hide(changeDuration);
            deliveryAddressDiv
                .hide(changeDuration);
            deliveryIntervalDiv
                .hide(changeDuration);

            if (deliveryAddressInput.val() === "") {
                deliveryAddressInput.val("Самовывоз");
            }

            if (cityInput.val() === "") {
                cityInput.val("Москва");
            }
        }

        function setDefaultMoscow() {
            cityDiv
                .hide(changeDuration);
            deliveryAddressDiv
                .show(changeDuration);
            deliveryIntervalDiv
                .show(changeDuration);

            if (deliveryAddressInput.val() === "Самовывоз") {
                deliveryAddressInput.val("");
            }

            if (cityInput.val() === "") {
                cityInput.val("Москва");
            }
        }

        function setDefaultRussia() {
            cityDiv
                .show(changeDuration);
            deliveryAddressDiv
                .show(changeDuration);
            deliveryIntervalDiv
                .hide(changeDuration);

            if (deliveryAddressInput.val() === "Самовывоз") {
                deliveryAddressInput.val("");
            }

            if (cityInput.val() === "Москва") {
                cityInput.val("");
            }
        }
    }

    // Functions for products pages
    {
        function setLastBreadCrumbName() {
            $('.t758__link-item_active').text(h1Text);
        }

        function setPointNavigationProductName() {
            $('a[href="#product"] > .t607__tooltip').text(h1Text)
        }
    }

    function fixDeliveryPriceFunc() {
        setInterval(function () {
            if (isCartWinShowed()) {
                let prodamount = window.tcart.prodamount;
                let amount = window.tcart.amount;

                if (prodamount !== undefined && amount !== undefined) {
                    let shouldPaid = !isSamovivoz($checkedDelivery) && prodamount < freeDeliveryCost && amount === prodamount;
                    let shouldFree = (isSamovivoz($checkedDelivery) || prodamount >= freeDeliveryCost) && amount !== prodamount;

                    if (shouldPaid || shouldFree) {

                        if (shouldPaid) {
                            $checkedDelivery.attr("data-delivery-price", paidDeliveryCost);
                        }

                        if (shouldFree) {
                            $checkedDelivery.attr("data-delivery-price", 0);
                        }

                        window.tcart.delivery = {};
                        window.tcart.delivery.name = $checkedDelivery.val();
                        window.tcart.delivery.price = $checkedDelivery.attr("data-delivery-price");

                        tcart__updateTotalProductsinCartObj(),
                            tcart__reDrawTotal();
                    }

                    if ($checkedDelivery.attr("data-delivery-price") === "") {
                        $deliveryClientCost.val(0);
                    } else {
                        $deliveryClientCost.val($checkedDelivery.attr("data-delivery-price"));
                    }
                }
            }
        }, fixDeliveryPriceCheckInterval);

        function isCartWinShowed() {
            if ($cartWindow === undefined) {
                $cartWindow = $(".t706__cartwin");
            }

            return $cartWindow.hasClass("t706__cartwin_showed")
        }
    }

    // Price objects
    {
        function setPrices() {

            $('.t744__title.js-product-name').each(function (idx) {
                let productName = $(this).text();

                //skip sets
                if (productName.toLowerCase().indexOf("set") > -1) {
                    return;
                }

                let priceWrapperDiv = $(this)
                    .parent() // t744__title-wrapper
                    .parent() // t744__textwrapper
                    .find('.t744__price-wrapper');

                let currentPriceDiv = priceWrapperDiv.find('.js-product-price');
                let oldPriceDiv = priceWrapperDiv.find('.t744__price_old');
                let oldPriceValueDiv = oldPriceDiv.find('.t744__price-value');

                setPrices0(productName, currentPriceDiv, oldPriceDiv, oldPriceValueDiv);
            });

            $('.t778__title.js-product-name').each(function (idx) {
                let productName = $(this).text();

                let priceWrapperDiv = $(this)
                                        .parent() // t778__textwrapper t778__paddingsmall
                                        .find('.t778__price-wrapper');

                let currentPriceDiv = priceWrapperDiv.find('.js-product-price');
                let oldPriceDiv = priceWrapperDiv.find('.t778__price_old');
                let oldPriceValueDiv = oldPriceDiv.find('.t778__price-value');

                setPrices0(productName, currentPriceDiv, oldPriceDiv, oldPriceValueDiv);
            });

            function setPrices0(productName, currentPriceDiv, oldPriceDiv, oldPriceValueDiv) {
                let productPrice = getPriceByProductName(productName);

                if (productPrice === undefined) {
                    console.error("Couldn't find price for: " + productName);
                    return;
                }

                currentPriceDiv.text(productPrice.cur);

                if (productPrice.old === undefined) {
                    oldPriceDiv.hide();
                } else {
                    oldPriceDiv.show();
                    oldPriceValueDiv.text(productPrice.old);
                }
            }

            function getPriceByProductName(productName) {
                if (productName === undefined) {
                    return undefined;
                }

                productName = productName.toLowerCase();

                if (productName.indexOf("ns-адаптер") > -1) return priceNsAdapter;
                if (productName.indexOf("barista") > -1) return priceBaristaKit;
                if (productName.indexOf("чехол") > -1) return priceCase;
                if (productName.indexOf("nanovessel") > -1) return priceNanovessel;

                if (productName.indexOf("minipresso") > -1) return priceMinipresso;

                if (productName.indexOf("tattoo") > -1) return priceNanopressoTattoo;

                if (productName.indexOf("patrol") > -1) return priceNanopresso;
                if (productName.indexOf("set") > -1) return priceNanopresso;
                if (productName.indexOf("nanopresso") > -1) return priceNanopresso;

                return undefined;
            }
        }

        function Price(cur, old) {
            this.cur = cur;

            if (cur >= old) {
                this.old = undefined;
            } else {
                this.old = old;
            }

            this.getPriceWithoutDiscount = function () {
                return old !== undefined ? this.old : this.cur;
            }
        }

        function getPriceWithDiscount(old) {
            let current = productDiscount <= 100
                ? getDiscountPrice(old, productDiscount)
                : old - productDiscount;

            return new Price(current, old);
        }
    }

    //Utils functions
    {
        function isSamovivoz(checkedDelivery) {
            return checkedDelivery !== undefined && checkedDelivery.val().toLowerCase().indexOf("самовывоз") > -1;
        }

        function isMoscow(checkedDelivery) {
            return checkedDelivery !== undefined && checkedDelivery.val().toLowerCase().indexOf("москв") > -1;
        }

        function isRussia(checkedDelivery) {
            return checkedDelivery !== undefined && checkedDelivery.val().toLowerCase().indexOf("росси") > -1;
        }

        function getDiscountPrice(oldPrice, discountPer) {
            let res = Math.floor(oldPrice * (1 - discountPer / 100));
            return res - (res % 10);
        }

    }

    function waitVar(variable, callback) {
        let maxCount = 10;
        let interval = setInterval(function () {
            try {
                if (maxCount < 0 || (variable() !== undefined && interval !== undefined) ) {
                    clearInterval(interval);
                    callback();
                }
            } catch (e) {
                //ignore
            };
            maxCount--;
        }, 1000);
    }

</script>
