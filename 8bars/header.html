<script type="text/javascript">

    let page;
    let productInfo = new ProductInfo();
    let isProductPage = false;
    let adminMode = false;

    // Wrapper for FB pixel
    let fbq2;

    // Configuration
    const fixDeliveryPriceCheckInterval = 500;
    const changeDuration = 400;

    // HTML elements
    let deliveryAddressDiv;
    let deliveryAddressInput;

    let cityDiv;
    let cityInput;

    let deliveryIntervalDiv;
    let deliveryIntervalInput;

    let h1Text;

    //Cdek
    let cdekDeliveryWidget;
    let cdekPvzInfoWidget;

    //JQuery objects
    let $cartForm;
    let $cartWindow;
    let $deliveryDescription;
    let $deliveryTypeRadios;
    let $deliveryClientCost;

    let $checkedDelivery;
    let $cdekDeliveryRadio;
    let $cdekDeliveryTimePost;
    let $deliveryRussiaTab;

    $(document).ready(function(){
        setGlobalVariables();

        setAdminElements();

        fixCartWindowFields();

        fixProductCarts();
        initInitiateCheckoutFunction();
        initMyAfterSendedFunction();

        if (isProductPage) {
            setLastBreadCrumbName();
            setPointNavigationProductName();
            setFbTrackViewContent(productInfo.price, productInfo.id);
        }

        setMetrikaGoals();

        waitVar(function(){return window.tcart_initted;}, fixDeliveryPriceFunc);
    });

    function setGlobalVariables() {
        let location = document.location;
        page = location.pathname;

        fbq2 = fbq !== undefined ? fbq : undefinedFbq2Func;
        if (ym === undefined) {
            ym = undefinedYmFunc;
        }

        productInfo = getProductInfoByPagePath(page);
        isProductPage = productInfo !== undefined;

        if (page.indexOf("admin") > -1) {
            adminMode = true;
        }

        $cartForm = $('.t706 form');
        $cartWindow = $(".t706__cartwin");
        $deliveryDescription = $('.t-input-subtitle.t-descr');
        $deliveryTypeRadios = $("input:radio[name='deliveryType']");
        $deliveryClientCost = $("input[name='deliveryClientCost']");

        deliveryAddressInput = $('input:text[name=deliveryAddress]');
        deliveryAddressDiv = deliveryAddressInput
            .parent()	// class="t-input-block"
            .parent();	// class="t-input-group t-input-group_in"

        cityInput = $('input:text[name=city]');
        cityDiv = cityInput
            .parent()	// class="t-input-block"
            .parent();	// class="t-input-group t-input-group_in"

        deliveryIntervalInput = $('input[name=deliveryInterval]');
        deliveryIntervalDiv = deliveryIntervalInput
            .parent()	// class="t-input-block"
            .parent();	// class="t-input-group t-input-group_in"

        h1Text = $('h1').text();

        $deliveryRussiaTab = $('#rec42659477').find('.t397__tab:last');
        $deliveryRussiaTab.click(function () {
            initCdekDeliveryWidget('info');
        });

        initCdekDeliveryWidget('order');
    }

    function setAdminElements() {
        let $sendSmsCbGroup = $cartForm.find(".t-input-group_cb").has("input[name='SendSmsAboutOrder']");

        if (adminMode) {
            $sendSmsCbGroup.show();
        } else {
            $sendSmsCbGroup.hide();
        }

    }

    // Events function
    {
        function initInitiateCheckoutFunction() {
            let $phoneInput = $('div.t-input-group.t-input-group_nm > div > input');

            $phoneInput.one("keyup", function () {
                setFbTracktInitiateCheckout(tcart.prodamount);
                reachMetrikaGoal("InitiateCheckout");
            });
        }

        function initMyAfterSendedFunction() {
            window.myAfterSendedFunction = function ($form) {
                let content_idsArr = [];
                for (let idx in tcart.products) {
                    let productName = tcart.products[idx].name;
                    let productInfo = getProductInfoByProductName(productName);

                    content_idsArr.push(productInfo.id);
                }

                let paymentId = getPaymentId(tildaForm.orderIdForStat);

                setFbTrackPurchase(tcart.prodamount, content_idsArr, paymentId);
                reachMetrikaGoal("Purchase");

                /**
                 * @param {string} orderIdForStat
                 * e.g. "T201907-1837361908"
                 */
                function getPaymentId(orderIdForStat) {
                    if (orderIdForStat === undefined || orderIdForStat === "") {
                        return "";
                    }

                    let start = orderIdForStat.indexOf("-") + 1;
                    let end = orderIdForStat.length - 1;

                    return orderIdForStat.substr(start, end);
                }
            };

            $cartForm.each(function () {
                $(this).data('formsended-callback', 'window.myAfterSendedFunction');
            });
        }
    }

    // Delivery functions
    {
        function DeliveryType(city, address) {
            this.city = city;
            this.address = address;
        }

        let currentDelivery;
        let selfTakeDelivery = new DeliveryType("Москва", "Самовывоз");
        let mskDelivery = new DeliveryType("Москва", "");
        let cdekDelivery = new DeliveryType("", "");

        function fixDeliveryInCart() {
            $cdekDeliveryRadio = $deliveryTypeRadios.filter(function () {
                return isRussia($(this));
            });
            $cdekDeliveryRadio.parent().append("<span id=\"cdekDeliveryTimePost\"></span>");
            $cdekDeliveryTimePost = $cdekDeliveryRadio.parent().find('#cdekDeliveryTimePost');

            //default Moscow delivery
            $checkedDelivery = $deliveryTypeRadios.filter(function () {
                return isMoscow($(this));
            });
            $checkedDelivery.prop("checked", true);
            setDefaultMoscow();

            //event listener
            $deliveryTypeRadios.change(function () {
                $checkedDelivery = $deliveryTypeRadios.filter(":checked");

                if (isSamovivoz($checkedDelivery)) {
                    setDefaultSamovivoz();

                } else if (isMoscow($checkedDelivery)) {
                    setDefaultMoscow();

                } else if (isRussia($checkedDelivery)) {
                    setDefaultRussia();
                }
            });
        }

        function setDefaultSamovivoz() {
            cityDiv.hide(changeDuration);
            deliveryAddressDiv.hide(changeDuration);
            deliveryIntervalDiv.hide(changeDuration);
            $cdekDeliveryTimePost.hide(changeDuration);

            setDelivery(selfTakeDelivery);
        }

        function setDefaultMoscow() {
            cityDiv.hide(changeDuration);
            deliveryAddressDiv.show(changeDuration);
            deliveryIntervalDiv.show(changeDuration);
            $cdekDeliveryTimePost.hide(changeDuration);

            setDelivery(mskDelivery);
        }

        function setDefaultRussia() {
            cityDiv.show(changeDuration);
            deliveryAddressDiv.show(changeDuration);
            deliveryIntervalDiv.hide(changeDuration);
            $cdekDeliveryTimePost.show(changeDuration);

            cdekDeliveryWidget.open();
        }

        function setDelivery(checkedDelivery) {
            if (currentDelivery !== undefined) {
                currentDelivery.city = cityInput.val();
                currentDelivery.address = deliveryAddressInput.val();
            }

            currentDelivery = checkedDelivery;

            cityInput.val(currentDelivery.city);
            deliveryAddressInput.val(currentDelivery.address);

            console.log("Delivery: " + cityInput.val() + ", " + deliveryAddressInput.val());
        }

        function initCdekDeliveryWidget(type) {
            let cdekPvzWidgetScriptsPath = 'https://8bars.000webhostapp.com/cdek-pvz-widget/widget/scripts/';

            if (type === 'order') {
                cdekDeliveryWidget = new ISDEKWidjet({
                    popup: true,
                    hidedress: true,
                    defaultCity: 'auto',
                    cityFrom: 'Москва',
                    path: cdekPvzWidgetScriptsPath,
                    goods: [ // установим данные о товарах из корзины
                        {length: 10, width: 10, height: 10, weight: 0.5}
                    ],
                    onReady: onReady,
                    onCalculate: onCalculate,
                    onChoose: onChoose,
                    onChooseProfile: onChoose
                });
            } else if (type === 'info') {
                cdekPvzInfoWidget = new ISDEKWidjet({
                    hidedress: true,
                    choose: false,
                    link: 'cdek-pvz-info-widjet',
                    defaultCity: 'auto',
                    cityFrom: 'Москва',
                    path: cdekPvzWidgetScriptsPath,
                    goods: [ // установим данные о товарах из корзины
                        { length : 10, width : 10, height : 10, weight : 0.5 }
                    ],
                    onReady : onReady,
                    onCalculate : onCalculate,
                    onChoose : onChoose,
                    onChooseProfile : onChoose
                });
            }

            function onReady() {
            }

            function onCalculate(info) {
            }

            function onChoose(info) {
                setDelivery(cdekDelivery);

                if (info.term === undefined) {
                    $cdekDeliveryTimePost.text("");
                } else {
                    $cdekDeliveryTimePost.text(" (срок ~" + info.term + " раб. дн.)");
                }

                cityInput.val(info.cityName);

                if (info.PVZ !== undefined) {
                    deliveryAddressInput.val("ПВЗ: " + info.PVZ.Address);
                } else {
                    if (deliveryAddressInput.val().indexOf("ПВЗ:") === 0) {
                        deliveryAddressInput.val("");
                    }
                }
            }
        }


        function isSamovivoz(checkedDelivery) {
            return checkedDelivery !== undefined && checkedDelivery.val().toLowerCase().indexOf("самовывоз") > -1;
        }

        function isMoscow(checkedDelivery) {
            return checkedDelivery !== undefined && checkedDelivery.val().toLowerCase().indexOf("москв") > -1;
        }

        function isRussia(checkedDelivery) {
            return checkedDelivery !== undefined && checkedDelivery.val().toLowerCase().indexOf("росси") > -1;
        }
    }

    // Fix products pages functions
    {
        function setLastBreadCrumbName() {
            $('.t758__link-item_active').text(h1Text);
        }

        function setPointNavigationProductName() {
            $('a[href="#product"] > .t607__tooltip').text(h1Text)
        }
    }

    // Fix cart functions
    {
        function fixCartWindowFields() {
            fixDeliveryInCart();
            fixPromoCodeInCart();
        }

        function fixPromoCodeInCart(){
            let $promoGroup = $cartForm.find(".t-input-group_pc");
            $promoGroup.hide();

            let $hasPromoCbGroup = $cartForm.find(".t-input-group_cb").has("input[name='hasPromo']");
            $hasPromoCbGroup.one('change', function () {
                $hasPromoCbGroup.hide(changeDuration);
                $promoGroup.show(changeDuration);
            });
        }

        function fixDeliveryPriceFunc() {
            setInterval(function () {
                if (isCartWinShowed()) {
                    let prodamount = window.tcart.prodamount;
                    let amount = window.tcart.amount;

                    if (prodamount !== undefined && amount !== undefined) {
                        let shouldPaid = !isSamovivoz($checkedDelivery) && prodamount < freeDeliveryCost && amount === prodamount;
                        let shouldFree = (isSamovivoz($checkedDelivery) || prodamount >= freeDeliveryCost) && amount !== prodamount;

                        if (shouldPaid || shouldFree) {

                            if (shouldPaid) {
                                $checkedDelivery.attr("data-delivery-price", paidDeliveryCost);
                            }

                            if (shouldFree) {
                                $checkedDelivery.attr("data-delivery-price", 0);
                            }

                            window.tcart.delivery = {};
                            window.tcart.delivery.name = $checkedDelivery.val();
                            window.tcart.delivery.price = $checkedDelivery.attr("data-delivery-price");

                            tcart__updateTotalProductsinCartObj(),
                                tcart__reDrawTotal();
                        }

                        if ($checkedDelivery.attr("data-delivery-price") === "") {
                            $deliveryClientCost.val(0);
                        } else {
                            $deliveryClientCost.val($checkedDelivery.attr("data-delivery-price"));
                        }
                    }
                }
            }, fixDeliveryPriceCheckInterval);

            function isCartWinShowed() {
                if ($cartWindow === undefined) {
                    $cartWindow = $(".t706__cartwin");
                }

                return $cartWindow.hasClass("t706__cartwin_showed")
            }
        }
    }

    // fix product carts functions
    {
        function fixProductCarts() {

            $('div.t744, div.t778__wrapper').each(function (idx) {
                let prod = $(this);

                let oldPriceDiv;
                let oldPriceValueDiv;
                let productName = prod.find(".js-product-name").text();
                let currentPriceValueDiv = prod.find('.js-product-price');
                let buyButton = prod.find("[href='#order']");

                let prodClass = $(this).attr("class");
                if (prodClass.indexOf("t778") !== -1) {
                    oldPriceDiv = prod.find('.t778__price_old');
                    oldPriceValueDiv = oldPriceDiv.find('.t778__price-value');
                } else {
                    oldPriceDiv = prod.find('.t744__price_old');
                    oldPriceValueDiv = oldPriceDiv.find('.t744__price-value');
                }

                let productInfo = getProductInfoByProductName(productName);

                if (productInfo === undefined) {
                    console.error("Couldn't find info for: " + productName);
                    return;
                }

                if (productName.toLowerCase().indexOf("set") === -1) {
                    setPrices(productInfo, productName, currentPriceValueDiv, oldPriceDiv, oldPriceValueDiv);

                    buyButton.click(function () {
                        setFbTrackAddToCart(productInfo);
                    });
                } else {
                    buyButton.click(function () {
                        setFbTrackAddToCart(infoSet);
                    });
                }
            });

        }

        /**
         * @param {ProductInfo} productInfo
         */
        function setPrices(productInfo, productName, currentPriceValueDiv, oldPriceDiv, oldPriceValueDiv) {
            currentPriceValueDiv.text(productInfo.price);

            if (productInfo.oldPrice === undefined) {
                oldPriceDiv.hide();
            } else {
                oldPriceDiv.show();
                oldPriceValueDiv.text(productInfo.oldPrice);
            }

            console.log(productName +": cur=" + currentPriceValueDiv.text() + ", old=" + oldPriceValueDiv.text());
        }

        /**
         * @param {string} pagePath The string
         * @return {ProductInfo}
         */
        function getProductInfoByPagePath(pagePath) {
            if (pagePath === undefined || pagePath === "" || pagePath === MAIN_PAGE) {
                return undefined;
            }

            pagePath = pagePath.toLowerCase();

            // replace "/page/" -> "/page"
            if (pagePath.charAt(pagePath.length-1) === '/') {
                pagePath = pagePath.substr(0, pagePath.length-1);
            }

            for (let idx in PRODUCTS_INFO) {
                let productInfo = PRODUCTS_INFO[idx];

                if (productInfo.hasOwnProperty("path") && productInfo.path === pagePath) {
                    return productInfo;
                }
            }

            console.log("productInfo not found by pagePath: " + pagePath);
            return undefined;
        }

        /**
         * @param {string} productName The string
         * @return {ProductInfo}
         */
        function getProductInfoByProductName(productName) {
            if (productName === undefined) {
                return undefined;
            }

            productName = productName.toLowerCase();

            if (productName.indexOf("ns-адаптер") > -1) return infoNsAdapter;
            if (productName.indexOf("barista") > -1)    return infoBaristaKit;
            if (productName.indexOf("чехол") > -1)      return infoCase;
            if (productName.indexOf("nanovessel") > -1) return infoNanovessel;

            if (productName.indexOf("minipresso") > -1) {
                if (productName.indexOf("ns") > -1) {
                    return infoMinipressoNs;
                } else {
                    return infoMinipressoGr;
                }
            }

            if (productName.indexOf("tattoo") > -1)     return infoNanopressoTattoo;

            if (productName.indexOf("patrol") > -1)     return infoNanopressoPatrol;
            if (productName.indexOf("set") > -1)        return infoSet;
            if (productName.indexOf("nanopresso") > -1) return infoNanopresso;

            if (productName.indexOf("тест") > -1)       return infoTest;

            console.log("productInfo not found by productName");
            return undefined;
        }
    }

    // Stats functions
    {
        /**
         * @param {ProductInfo} productInfo
         */
        function setFbTrackAddToCart(productInfo) {
            fbq2('track', 'AddToCart', {
                value: productInfo.price,
                currency: 'RUB',
                content_ids: productInfo.id,
                content_type: 'product',
            });
        }

        function setFbTrackViewContent(value, content_ids) {
            fbq2('track', 'ViewContent', {
                value: value,
                currency: 'RUB',
                content_ids: content_ids,
                content_type: 'product',
            });
        }

        function setFbTracktInitiateCheckout(value) {
            fbq2('track', 'InitiateCheckout', {
                value: value,
                currency: 'RUB'
            });
        }

        function setFbTrackPurchase(value, content_ids, paymentId) {
            fbq2('track', 'Purchase', {
                value: value,
                currency: 'RUB',
                content_ids: content_ids,
                content_type: 'product',
                paymentId: paymentId
            });
        }

        function undefinedFbq2Func() {
            console.log("fbq2 is undefined, args: [" + arguments[0]+", " + arguments[1] + "]");
        }

        function undefinedYmFunc() {
            console.log("ym is undefined, args: [" + arguments[0]+", " + arguments[1] + "]");
        }

        function setMetrikaGoals() {
            $("[href='#order']").click(function() {
                reachMetrikaGoal("OpenCartPopUp");
            });

            $('.t706__carticon').click(function(){
                reachMetrikaGoal("OpenCartPopUp");
            });

            //Stats for CDEK widget
            $deliveryRussiaTab.click(function(){
                reachMetrikaGoal("OpenDeliveryRussiaTab");
            });

            $cdekDeliveryRadio.click(function(){
                reachMetrikaGoal("OpenDeliveryRussiaRadioInCart");
            });
        }

        function reachMetrikaGoal(goalName) {
            console.log("send " + goalName + " to yaMetrika");
            ym(ymCounterNum, 'reachGoal', goalName);
        }
    }

    // Utils functions
    {
        function waitVar(variable, callback) {
            let maxCount = 10;
            let interval = setInterval(function () {
                try {
                    if (maxCount < 0 || (variable() !== undefined && interval !== undefined) ) {
                        clearInterval(interval);
                        callback();
                    }
                } catch (e) {
                    //ignore
                };
                maxCount--;
            }, 1000);
        }
    }



</script>
