<script type="text/javascript">

    let page;
    let productInfo = new ProductInfo();
    let isProductPage = false;
    let adminMode = false;

    // Configuration
    const fixDeliveryPriceCheckInterval = 500;
    const changeDuration = 400;

    // HTML elements
    let deliveryAddressDiv;
    let deliveryAddressInput;

    let cityDiv;
    let cityInput;

    let deliveryIntervalDiv;
    let deliveryIntervalInput;

    let h1Text;

    //JQuery objects
    let $cartWindow;
    let $deliveryDescription;
    let $deliveryTypeRadios;
    let $deliveryClientCost;

    let $checkedDelivery;

    $(document).ready(function(){
        setGlobalVariables();

        setAdminElements();

        setMetrikaGoals();
        setCartWindowFields();

        fixProductCarts();
        setFbTrackInitiateCheckout();
        setFbTrackPurchase();

        if (isProductPage) {
            fixProductPageCart();
            setLastBreadCrumbName();
            setPointNavigationProductName();
            setFbTrackViewContent();
        }

        waitVar(function(){return window.tcart_initted;}, fixDeliveryPriceFunc);
    });

    function setGlobalVariables() {
        let location = document.location;
        page = location.pathname;

        productInfo = getProductInfoByPagePath(page);
        isProductPage = productInfo !== undefined;

        if (page.indexOf("admin") > -1) {
            adminMode = true;
        }

        $cartWindow = $(".t706__cartwin");
        $deliveryDescription = $('.t-input-subtitle.t-descr');
        $deliveryTypeRadios = $("input:radio[name='deliveryType']");
        $deliveryClientCost = $("input[name='deliveryClientCost']");

        deliveryAddressInput = $('input:text[name=deliveryAddress]');
        deliveryAddressDiv = deliveryAddressInput
            .parent()	// class="t-input-block"
            .parent();	// class="t-input-group t-input-group_in"

        cityInput = $('input:text[name=city]');
        cityDiv = cityInput
            .parent()	// class="t-input-block"
            .parent();	// class="t-input-group t-input-group_in"

        deliveryIntervalInput = $('input[name=deliveryInterval]');
        deliveryIntervalDiv = deliveryIntervalInput
            .parent()	// class="t-input-block"
            .parent();	// class="t-input-group t-input-group_in"

        h1Text = $('h1').text();
    }

    function setAdminElements() {
        let sendSmsCheckbox = $('input:checkbox[name=SendSmsAboutOrder]');
        let sendSmsDiv = sendSmsCheckbox
            .parent()	// class="t-checkbox__control t-text t-text_xs"
            .parent()	// class="t-input-block"
            .parent();	// class="t-input-group t-input-group_cb"

        if (adminMode) {
            sendSmsDiv.show();
        } else {
            sendSmsDiv.hide();
        }

    }

    function setMetrikaGoals() {
        $("[href='#order']").click(function() {
            console.log('Goal: OpenCartPopUp by #order');

            console.log("send to yaCounter44688592");
            if (yaCounter44688592 !== undefined) {
                yaCounter44688592.reachGoal('OpenCartPopUp');
            } else {
                console.log("yaCounter44688592 is undefined")
            }
        });

        $('.t706__carticon').click(function(){
            console.log('Goal: OpenCartPopUp by .t706__carticon');

            console.log("send to yaCounter44688592");
            if (yaCounter44688592 !== undefined) {
                yaCounter44688592.reachGoal('OpenCartPopUp');
            } else {
                console.log("yaCounter44688592 is undefined")
            }
        });
    }

    function setCartWindowFields() {
        $checkedDelivery = $deliveryTypeRadios.filter(function () {return isMoscow($(this));});
        $checkedDelivery.prop("checked", true);
        setDefaultMoscow();

        $deliveryTypeRadios.change(function(){
            $checkedDelivery = $deliveryTypeRadios.filter(":checked");

            if (isSamovivoz($checkedDelivery)) {
                setDefaultSamovivoz();

            } else if (isMoscow($checkedDelivery)) {
                setDefaultMoscow();

            } else if (isRussia($checkedDelivery)) {
                setDefaultRussia();
            }
        });

        function setDefaultSamovivoz() {
            cityDiv
                .hide(changeDuration);
            deliveryAddressDiv
                .hide(changeDuration);
            deliveryIntervalDiv
                .hide(changeDuration);

            if (deliveryAddressInput.val() === "") {
                deliveryAddressInput.val("Самовывоз");
            }

            if (cityInput.val() === "") {
                cityInput.val("Москва");
            }
        }

        function setDefaultMoscow() {
            cityDiv
                .hide(changeDuration);
            deliveryAddressDiv
                .show(changeDuration);
            deliveryIntervalDiv
                .show(changeDuration);

            if (deliveryAddressInput.val() === "Самовывоз") {
                deliveryAddressInput.val("");
            }

            if (cityInput.val() === "") {
                cityInput.val("Москва");
            }
        }

        function setDefaultRussia() {
            cityDiv
                .show(changeDuration);
            deliveryAddressDiv
                .show(changeDuration);
            deliveryIntervalDiv
                .hide(changeDuration);

            if (deliveryAddressInput.val() === "Самовывоз") {
                deliveryAddressInput.val("");
            }

            if (cityInput.val() === "Москва") {
                cityInput.val("");
            }
        }
    }

    // Functions for products pages
    {
        function setLastBreadCrumbName() {
            $('.t758__link-item_active').text(h1Text);
        }

        function setPointNavigationProductName() {
            $('a[href="#product"] > .t607__tooltip').text(h1Text)
        }
    }

    function fixDeliveryPriceFunc() {
        setInterval(function () {
            if (isCartWinShowed()) {
                let prodamount = window.tcart.prodamount;
                let amount = window.tcart.amount;

                if (prodamount !== undefined && amount !== undefined) {
                    let shouldPaid = !isSamovivoz($checkedDelivery) && prodamount < freeDeliveryCost && amount === prodamount;
                    let shouldFree = (isSamovivoz($checkedDelivery) || prodamount >= freeDeliveryCost) && amount !== prodamount;

                    if (shouldPaid || shouldFree) {

                        if (shouldPaid) {
                            $checkedDelivery.attr("data-delivery-price", paidDeliveryCost);
                        }

                        if (shouldFree) {
                            $checkedDelivery.attr("data-delivery-price", 0);
                        }

                        window.tcart.delivery = {};
                        window.tcart.delivery.name = $checkedDelivery.val();
                        window.tcart.delivery.price = $checkedDelivery.attr("data-delivery-price");

                        tcart__updateTotalProductsinCartObj(),
                            tcart__reDrawTotal();
                    }

                    if ($checkedDelivery.attr("data-delivery-price") === "") {
                        $deliveryClientCost.val(0);
                    } else {
                        $deliveryClientCost.val($checkedDelivery.attr("data-delivery-price"));
                    }
                }
            }
        }, fixDeliveryPriceCheckInterval);

        function isCartWinShowed() {
            if ($cartWindow === undefined) {
                $cartWindow = $(".t706__cartwin");
            }

            return $cartWindow.hasClass("t706__cartwin_showed")
        }
    }

    // fixProduct functions
    {
        function fixProductPageCart() {

            // block with 1 product
            $('.t744__title.js-product-name').each(function (idx) {
                let productName = $(this).text();

                //skip sets
                if (productName.toLowerCase().indexOf("set") > -1) {
                    return;
                }

                let textWrapperDiv = $(this)
                    .parent() // t744__title-wrapper
                    .parent(); // t744__textwrapper

                let currentPriceDiv = textWrapperDiv.find('.js-product-price');
                let oldPriceDiv = textWrapperDiv.find('.t744__price_old');
                let oldPriceValueDiv = oldPriceDiv.find('.t744__price-value');

                setPrices(productInfo, currentPriceDiv, oldPriceDiv, oldPriceValueDiv);

                let buyButton = textWrapperDiv.find("[href='#order']");
                buyButton.click(function () {
                    setFbTrackAddToCart(productInfo);
                });
            });
        }

        function fixProductCarts() {

            // block with several products
            $('.t778__title.js-product-name').each(function (idx) {
                let productName = $(this).text();

                //skip sets
                if (productName.toLowerCase().indexOf("set") > -1) {
                    return;
                }

                let productWrapperDiv = $(this)
                    .parents("div.t778__wrapper");


                let currentPriceDiv = productWrapperDiv.find('.js-product-price');
                let oldPriceDiv = productWrapperDiv.find('.t778__price_old');
                let oldPriceValueDiv = oldPriceDiv.find('.t778__price-value');

                let productInfo = getProductInfoByProductName(productName);

                if (productInfo === undefined) {
                    console.error("Couldn't find info for: " + productName);
                    return;
                }

                setPrices(productInfo, currentPriceDiv, oldPriceDiv, oldPriceValueDiv);

                let buyButton = productWrapperDiv.find("[href='#order']");
                buyButton.click(function () {
                    setFbTrackAddToCart(productInfo);
                });
            });
        }

        /**
         * @param {ProductInfo} productInfo
         */
        function setPrices(productInfo, currentPriceDiv, oldPriceDiv, oldPriceValueDiv) {
            currentPriceDiv.text(productInfo.price);

            if (productInfo.oldPrice === undefined) {
                oldPriceDiv.hide();
            } else {
                oldPriceDiv.show();
                oldPriceValueDiv.text(productInfo.oldPrice);
            }
        }

        /**
         * @param {string} pagePath The string
         * @return {ProductInfo}
         */
        function getProductInfoByPagePath(pagePath) {
            if (pagePath === undefined || pagePath === "" || pagePath === MAIN_PAGE) {
                return undefined;
            }

            pagePath = pagePath.toLowerCase();

            // replace "/page/" -> "/page"
            if (pagePath.charAt(pagePath.length-1) === '/') {
                pagePath = pagePath.substr(0, pagePath.length-1);
            }

            for (let idx in PRODUCTS_INFO) {
                let productInfo = PRODUCTS_INFO[idx];

                if (productInfo.hasOwnProperty("path") && productInfo.path === pagePath) {
                    return productInfo;
                }
            }

            console.log("productInfo not found by pagePath");
            return undefined;
        }

        /**
         * @param {string} productName The string
         * @return {ProductInfo}
         */
        function getProductInfoByProductName(productName) {
            if (productName === undefined) {
                return undefined;
            }

            productName = productName.toLowerCase();

            if (productName.indexOf("ns-адаптер") > -1) return infoNsAdapter;
            if (productName.indexOf("barista") > -1)    return infoBaristaKit;
            if (productName.indexOf("чехол") > -1)      return infoCase;
            if (productName.indexOf("nanovessel") > -1) return infoNanovessel;

            if (productName.indexOf("minipresso") > -1) {
                if (productName.indexOf("ns") > -1) {
                    return infoMinipressoNs;
                } else {
                    return infoMinipressoGr;
                }
            }

            if (productName.indexOf("tattoo") > -1)     return infoNanopressoTattoo;

            if (productName.indexOf("patrol") > -1)     return infoNanopressoPatrol;
            if (productName.indexOf("set") > -1)        return infoSet;
            if (productName.indexOf("nanopresso") > -1) return infoNanopresso;

            if (productName.indexOf("тест") > -1)       return infoTest;

            console.log("productInfo not found by productName");
            return undefined;
        }
    }

    // FB functions
    {
        function setFbTrackViewContent() {
            fbq('track', 'ViewContent', {
                value: productInfo.price,
                currency: 'RUB',
                content_ids: productInfo.id,
                content_type: 'product',
            });
        }

        /**
         * @param {ProductInfo} productInfo
         */
        function setFbTrackAddToCart(productInfo) {
            fbq('track', 'AddToCart', {
                value: productInfo.price,
                currency: 'RUB',
                content_ids: productInfo.id,
                content_type: 'product',
            });
        }

        function setFbTrackInitiateCheckout() {
            let $phoneInput = $('div.t-input-group.t-input-group_nm > div > input');

            $phoneInput.one("input", function(){
                fbq('track', 'InitiateCheckout', {
                    value: tcart.prodamount,
                    currency: 'RUB'
                    //content_ids: productInfo.id,
                    //content_type: 'product',
                });
            });
        }

        function setFbTrackPurchase() {
            let $makeOrderButton = $('div.t-form__submit > button');

            $makeOrderButton.one("click", function(){
                let content_idsArr = [];
                for (let idx in tcart.products) {
                    let productName = tcart.products[idx].name;
                    let productInfo = getProductInfoByProductName(productName);

                    content_idsArr.push(productInfo.id);
                }

                fbq('track', 'Purchase', {
                    value: tcart.prodamount,
                    currency: 'RUB',
                    content_ids: content_idsArr,
                    content_type: 'product',
                });
            });
        }
    }

    //Utils functions
    {
        function isSamovivoz(checkedDelivery) {
            return checkedDelivery !== undefined && checkedDelivery.val().toLowerCase().indexOf("самовывоз") > -1;
        }

        function isMoscow(checkedDelivery) {
            return checkedDelivery !== undefined && checkedDelivery.val().toLowerCase().indexOf("москв") > -1;
        }

        function isRussia(checkedDelivery) {
            return checkedDelivery !== undefined && checkedDelivery.val().toLowerCase().indexOf("росси") > -1;
        }
    }

    function waitVar(variable, callback) {
        let maxCount = 10;
        let interval = setInterval(function () {
            try {
                if (maxCount < 0 || (variable() !== undefined && interval !== undefined) ) {
                    clearInterval(interval);
                    callback();
                }
            } catch (e) {
                //ignore
            };
            maxCount--;
        }, 1000);
    }

</script>
